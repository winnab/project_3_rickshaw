function main(){initRoutesList(),initMap(),getData()}function initRoutesList(){window.app||(window.app={}),app.$stopsList=$("#stops-list")}function initMap(){var e={zoom:15,center:new google.maps.LatLng(37.771947,-122.424438)};bounds=new google.maps.LatLngBounds,map=new google.maps.Map(document.getElementById("map-canvas"),e),directionsDisplay.setMap(map)}function getData(){$.getJSON("/drivers",handleData)}function normalizeData(e){return normData=$.each(e.drivers,function(e,r){$.each(r.stops,function(e,r){r.index=e+1,r.is_pickup="pickup"==r.stop_type,r.is_due=null==r.job_status,r.is_done="done_ok"==r.job_status,r.is_overdue="overdue"==r.job_status})})}function handleData(e){window.data=normalizeData(e),renderDriversList(e),renderDriverCurrLocMap(e)}function renderDriversList(e){$("#active-drivers, #inactive-drivers").html(""),$.each(e.drivers,renderDriversNamesList),void 0!=displayed_driver&&(renderDriverStopsList(displayed_driver),renderDriverStopsMap(displayed_driver)),$(".driver-name-box").on("click",function(){$(".stops-box").hide(600),clearStopMarkers();var r=parseInt($(this).attr("id").replace(/\D+/g,"")),o=_.findWhere(e.drivers,{id:r});displayed_driver=o,renderDriverStopsList(o),renderDriverStopsMap(o)})}function renderDriversNamesList(e,r){var o=r.stops,n=o.length>0?"#active-drivers":"#inactive-drivers",i=$("#driver_route").html(),t=Handlebars.compile(i);$(n).append(t(r))}function renderDriverStopsList(e){var r=$("#driver_stops").html(),o=Handlebars.compile(r);$.each(e.stops,function(e,r){$("#driver_"+r.driver_id+"_stop_"+e).append(o(r))})}function getStopStatusIcon(e,r){switch(r.job_status){case null:var o={url:"http://goo.gl/cJjBaI",size:new google.maps.Size(30,30),origin:new google.maps.Point(30,0),anchor:new google.maps.Point(0,45)};return o;case"done_ok":var o={url:"http://goo.gl/cJjBaI",size:new google.maps.Size(30,30),origin:new google.maps.Point(60,0),anchor:new google.maps.Point(0,60)};return o;case"overdue":var o={url:"http://goo.gl/cJjBaI",size:new google.maps.Size(90,30),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,75)};return o;default:}return o}function renderDriverCurrLocMap(e){clearDriverMarkers(),$.each(e.drivers,renderDriversCurrLocMap),driverLocIndex+=1}function renderDriversCurrLocMap(e,r){if(r.locations.length>=1){var o={url:"http://goo.gl/cJjBaI",size:new google.maps.Size(30,30),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,45)},n=r.locations[driverLocIndex],i=new google.maps.LatLng(n.lat,n.lng),t=new google.maps.Marker({position:i,map:map,title:r.username,icon:o});markers.push(t),extendBoundaries()}}function renderDriverStopsMap(e){$.each(e.stops,renderStopsLocations)}function renderStopsLocations(e,r){var o=new google.maps.LatLng(r.latitude,r.longitude),n=new google.maps.Marker({position:o,map:map,title:r.stop_address,icon:getStopStatusIcon(e,r)});stop_markers.push(n),stopInfoWindow(map,n),extendBoundaries()}function stopInfoWindow(e,r){var o="test",n=new google.maps.InfoWindow({content:o});google.maps.event.addListener(r,"click",function(){n.open(e,r)})}function renderDirections(e,r){var o={origin:e,destination:r,travelMode:google.maps.TravelMode.DRIVING};directionsService.route(o,function(e){directionsDisplay.setDirections(e)})}function setAllMap(e,r){for(var o=0;o<r.length;o++)r[o].setMap(e)}function extendBoundaries(){$.each(markers,function(e,r){bounds.extend(r.position)}),map.fitBounds(bounds)}function clearDriverMarkers(){setAllMap(null,markers)}function clearStopMarkers(){setAllMap(null,stop_markers)}function showMarkers(){setAllMap(map)}function deleteMarkers(){clearMarkers(),markers=[]}var map,bounds,driverLocIndex=0,markers=[],stop_markers=[],displayed_driver,directionsService=new google.maps.DirectionsService,directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!1}),data;$(document).ready(main);